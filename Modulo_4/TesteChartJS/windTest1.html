<!doctype html>
<head>
	<title>Terrain Sample with Glacier 3D</title>
	<link href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css" rel="stylesheet">
	<script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.min.js" type="text/javascript"></script>
    <link href="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.css" rel="stylesheet" />
	<script src="config.js"></script>
	<style>
		body {
			margin: 0;
			padding: 0;
		}

		html, body, #map {
			height: 100%;
		}
		#time {
			position: absolute;
			left: 0;
			right: 0;
			bottom: 80px;
			margin-left: auto;
			margin-right: auto;
			min-width: 90%;
			z-index: 1;
		}

		#hour {
			background: rgba(0, 0, 0, 0.5);
			color: #fff;
			position: absolute;
			left: 0px;
			right: 0px;
			bottom: 40px;
			margin-left: auto;
			margin-right: auto;
			max-width: 30%;
			padding: 5px 10px;
			font-size: 18px;
			line-height: 18px;
			border-radius: 3px;
			text-align: center;
			z-index: 1;
		}
	</style>
</head>
<body>
	<div id='map' class='map'>
	<div id="hour" class="mapboxgl-map"></div>
	<input id='time' type='range' min="0" max="86400" />

	<script type="module">

		/// Glacier model from https://github.com/jbbarre

		//This demo shows a satellite mapbox style the following features:
		//- Built-in sunlight through 'realSunlight' that sets the scene and map lights based on 'setSunlight'
		//- Built-in sky layer through 'sky' that sets the sun layer synced with sunlight
		//- Built-in terrain layer through 'terrain' that sets the terrain layer synced with sunlight
		//- Built-in raycasting and selection through 'enableSelectingObjects' 
		//- Built-in Tooltips on for through 'enableTooltips' 

		if (!config) console.error("Config not set! Make a copy of 'config_template.js', add in your access token, and save the file as 'config.js'.");

		mapboxgl.accessToken = config.accessToken;
		//starting location for map
		let popup;
		let minZoom = 12;
		let seconds = 0;
		let date = new Date();
		let mapConfig = {
			PAR: {
				origin: [-40.89640, -9.52629, 665], center: [-40.890795, -9.521056], zoom: 17.5, pitch: 70, bearing: 0, scale: 0.004, rotation: { x: 90, y: 177, z: 0 }, timezone: 'America/Sao_Paulo', obj: 'https://brittoeduardo.github.io/html-css/Modulo_4/TesteChartJS/windmill_a.gltf',
			},
			names: {
				customLayer: "custom-layer",
				fillExtrusion: "composite-b",
				fillExtrusionLayer: "building-b"
			}
		}
		let origin2 = [-40.89488, -9.52418, 645] //[-40.89484, -9.52428, 645]
		let origin3 = [-40.89271, -9.52275, 625]
		let origin4 = [-40.890795, -9.521056, 625]
		let origin5 = [-40.88886, -9.51935, 615]
		let origin6 = [-40.88701, -9.51766, 610]
		let origin7 = [-40.88533, -9.51581, 610]
		let origin8 = [-40.88389, -9.51380, 610]
		let origin9 = [-40.88256, -9.51154, 610]
		let origin10 = [-40.88185, -9.50898, 610]

        var modelAsMercatorCoordinate = mapboxgl.MercatorCoordinate.fromLngLat(
			mapConfig.PAR.origin,
			620
		);
		let scale = modelAsMercatorCoordinate.meterInMercatorCoordinateUnits();
		console.log(scale);

		let point = mapConfig.PAR;
		var map = new mapboxgl.Map({
			style: 'mapbox://styles/mapbox/satellite-streets-v9', //'mapbox://styles/mapbox/outdoors-v11', //'mapbox://styles/mapbox/dark-v10',//'mapbox://styles/mapbox/light-v10',//'mapbox://styles/mapbox/satellite-streets-v9',
			center: point.center,
			zoom: point.zoom,
			pitch: point.pitch,
			bearing: point.bearing,
			container: 'map',
			antialias: true, 
			hash: true,
		});
        
		map.addControl(new mapboxgl.NavigationControl());

		window.tb = new Threebox(
			map,
			map.getCanvas().getContext('webgl'),
			{
				realSunlight: true,
                defaultLights: true,
				sky: true,
				terrain: true,
				enableSelectingObjects: true, 
				enableTooltips: true,
			}
		);

		var time = date.getHours() * 60 * 60 + date.getMinutes() * 60 + date.getSeconds();
		var timeInput = document.getElementById('time');
		timeInput.value = time;
		timeInput.oninput = () => {
			time = +timeInput.value;
			date.setHours(Math.floor(time / 60 / 60));
			date.setMinutes(Math.floor(time / 60) % 60);
			date.setSeconds(time % 60);
			console.log(date);
			map.triggerRepaint();
		};

		let stats;
		import Stats from 'https://threejs.org/examples/jsm/libs/stats.module.js';
		function animate() {
			requestAnimationFrame(animate);
			stats.update();
		}

		map.on('style.load', function () {

			// stats
			stats = new Stats();
			map.getContainer().appendChild(stats.dom);
			animate();

			// add the DEM source as a terrain layer with exaggerated height
			//map.addSource('mapbox-dem', {
			//	'type': 'raster-dem',
			//	'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
			//	'tileSize': 512,
			//	'maxzoom': 14
			//});
			//map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.0 });
			//map.setPaintProperty('satellite', 'raster-opacity', 0.1);

			map.addLayer({
				id: mapConfig.names.customLayer,
				type: 'custom',
				renderingMode: '3d',
				onAdd: function (map, mbxContext) {

					let options = {
						obj: mapConfig.PAR.obj,
						type: 'gltf',
						scale: mapConfig.PAR.scale,
						units: 'meters',
						rotation: mapConfig.PAR.rotation,
						anchor: 'center'
					}

					tb.loadObj(options, function (model) {
						model.setCoords(mapConfig.PAR.origin);
						model.addTooltip("PR1-01", true);
						//model.color = 0xffffff;
						//model.selected = true;
						model.playDefault({ animation: 0, duration: 3000000 });
						tb.add(model);
					})

					let options2 = {
						obj: mapConfig.PAR.obj,
						type: 'gltf',
						scale: mapConfig.PAR.scale,
						units: 'meters',
						rotation: mapConfig.PAR.rotation,
						anchor: 'center'
					}

					tb.loadObj(options2, function (model) {
						model.setCoords(origin2);
						model.addTooltip("PR1-02", true);
						//model.color = 0xffffff;
						//model.selected = true;
						model.playDefault({ animation: 0, duration: 3000000 });
						tb.add(model);
					})

					let options3 = {
						obj: mapConfig.PAR.obj,
						type: 'gltf',
						scale: mapConfig.PAR.scale,
						units: 'meters',
						rotation: mapConfig.PAR.rotation,
						anchor: 'center'
					}

					tb.loadObj(options3, function (model) {
						model.setCoords(origin3);
						model.addTooltip("PR1-03", true);
						//model.color = 0xffffff;
						//model.selected = true;
						model.playDefault({ animation: 0, duration: 3000000 });
						tb.add(model);
					})
					let options4 = {
						obj: mapConfig.PAR.obj,
						type: 'gltf',
						scale: mapConfig.PAR.scale,
						units: 'meters',
						rotation: mapConfig.PAR.rotation,
						anchor: 'center'
					}

					tb.loadObj(options4, function (model) {
						model.setCoords(origin4);
						model.addTooltip("PR1-04", true);
						//model.color = 0xffffff;
						//model.selected = true;
						model.playDefault({ animation: 0, duration: 3000000 });
						tb.add(model);
					})
					let options5 = {
						obj: mapConfig.PAR.obj,
						type: 'gltf',
						scale: mapConfig.PAR.scale,
						units: 'meters',
						rotation: mapConfig.PAR.rotation,
						anchor: 'center'
					}

					tb.loadObj(options5, function (model) {
						model.setCoords(origin5);
						model.addTooltip("PR1-05", true);
						//model.color = 0xffffff;
						//model.selected = true;
						model.playDefault({ animation: 0, duration: 3000000 });
						tb.add(model);
					})
					let options6 = {
						obj: mapConfig.PAR.obj,
						type: 'gltf',
						scale: mapConfig.PAR.scale,
						units: 'meters',
						rotation: mapConfig.PAR.rotation,
						anchor: 'center'
					}

					tb.loadObj(options6, function (model) {
						model.setCoords(origin6);
						model.addTooltip("PR1-06", true);
						//model.color = 0xffffff;
						//model.selected = true;
						model.playDefault({ animation: 0, duration: 3000000 });
						tb.add(model);
					})
					let options7 = {
						obj: mapConfig.PAR.obj,
						type: 'gltf',
						scale: mapConfig.PAR.scale,
						units: 'meters',
						rotation: mapConfig.PAR.rotation,
						anchor: 'center'
					}

					tb.loadObj(options7, function (model) {
						model.setCoords(origin7);
						model.addTooltip("PR1-07", true);
						//model.color = 0xffffff;
						//model.selected = true;
						model.playDefault({ animation: 0, duration: 3000000 });
						tb.add(model);
					})
					let options8 = {
						obj: mapConfig.PAR.obj,
						type: 'gltf',
						scale: mapConfig.PAR.scale,
						units: 'meters',
						rotation: mapConfig.PAR.rotation,
						anchor: 'center'
					}

					tb.loadObj(options8, function (model) {
						model.setCoords(origin8);
						model.addTooltip("PR1-08", true);
						//model.color = 0xffffff;
						//model.selected = true;
						model.playDefault({ animation: 0, duration: 3000000 });
						tb.add(model);
					})
					let options9 = {
						obj: mapConfig.PAR.obj,
						type: 'gltf',
						scale: mapConfig.PAR.scale,
						units: 'meters',
						rotation: mapConfig.PAR.rotation,
						anchor: 'center'
					}

					tb.loadObj(options9, function (model) {
						model.setCoords(origin9);
						model.addTooltip("PR1-09", true);
						//model.color = 0xffffff;
						//model.selected = true;
						model.playDefault({ animation: 0, duration: 3000000 });
						tb.add(model);
					})
					let options10 = {
						obj: mapConfig.PAR.obj,
						type: 'gltf',
						scale: mapConfig.PAR.scale,
						units: 'meters',
						rotation: mapConfig.PAR.rotation,
						anchor: 'center'
					}

					tb.loadObj(options10, function (model) {
						model.setCoords(origin10);
						model.addTooltip("PR1-10", true);
						//model.color = 0xffffff;
						//model.selected = true;
						model.playDefault({ animation: 0, duration: 3000000 });
						tb.add(model);
					})

				},

				render: function (gl, matrix) {
					tb.setSunlight(date, point.center);
					hour.innerHTML = "Local date/time: " + dateToTimezone(date, point.timezone).toLocaleString();
					tb.update();
				}
			});

		});

		function dateToTimezone(date = new Date(), timezone) {
			var tzTime = date.toLocaleString("en-US", { timeZone: timezone });
			return new Date(tzTime);

		}
	</script>
</body>